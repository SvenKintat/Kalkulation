<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wildbestand – Kosten & Bestände</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#1f2937;       /* gray-800 */
      --text:#e5e7eb;        /* gray-200 */
      --soft:#9ca3af;        /* gray-400 */
      --brand:#22c55e;       /* green-500 */
      --brand-weak:#14532d;  /* green-900 */
      --danger:#ef4444;      /* red-500 */
      --warning:#f59e0b;     /* amber-500 */
      --ok:#10b981;          /* emerald-500 */
      --card:#0b1222;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:linear-gradient(180deg,#0b1020,#0a0f1a 60%,#070b13);
      color:var(--text); line-height:1.45;
    }
    header{
      position:sticky; top:0; z-index:30; backdrop-filter: blur(8px);
      background:rgba(10,15,26,.75); border-bottom:1px solid #111827aa;
    }
    .container{max-width:1200px; margin:0 auto; padding:18px}
    .row{display:grid; gap:16px}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:960px){ .grid-3{grid-template-columns:1fr} }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px;
    }
    .brand .dot{width:12px; height:12px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 6px #22c55e22}
    nav{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px
    }
    .tab-btn{
      border:1px solid #1f2937; background:#0c1323; color:var(--text);
      padding:10px 14px; border-radius:999px; cursor:pointer;
      transition:.2s; box-shadow: inset 0 0 0 1px #0b1222;
    }
    .tab-btn.active{background:var(--brand-weak); border-color:#166534}
    .panel{
      background:linear-gradient(180deg,#0b1325,#0b1222);
      border:1px solid #1f2937; border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px;
    }
    h1{font-size:22px; margin:0}
    h2{font-size:18px; margin:0 0 8px 0}
    .kpi{
      padding:18px; border-radius:16px; background:linear-gradient(180deg,#0c152b,#0b1325);
      border:1px solid #1f2937; box-shadow:var(--shadow);
    }
    .kpi small{color:var(--soft)}
    .kpi .value{font-size:22px; font-weight:700; margin-top:6px}
    .muted{color:var(--soft)}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #1f2937; background:#0d1426}
    .flex{display:flex; gap:12px; align-items:center}
    .spacer{flex:1}
    .btn{
      border:1px solid #243249; background:#0e1a31; color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.brand{background:#14532d; border-color:#166534}
    .btn.danger{background:#2a0f13; border-color:#3f1218}
    .btn.warn{background:#3b2a0a; border-color:#553b0b}
    .btn.ghost{background:transparent}
    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid #1f2937;
      background:#0c1426; color:var(--text);
    }
    label{font-size:13px; color:var(--soft)}
    .field{display:grid; gap:6px}
    .table-wrap{overflow:auto; border-radius:14px; border:1px solid #1f2937}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:880px; background:#0b1325}
    thead th{
      position:sticky; top:0; background:#0a1122; text-align:left; font-weight:600; padding:10px;
      border-bottom:1px solid #1f2937; color:#c7d2fe;
    }
    tbody td{padding:10px; border-bottom:1px solid #1f2937}
    tbody tr:hover{background:#0e1630}
    .right{text-align:right}
    .pill{padding:4px 8px; border-radius:999px; background:#0c1426; border:1px solid #1f2937; font-size:12px}
    .status-ok{color:#86efac}
    .status-warn{color:#fcd34d}
    .status-bad{color:#fca5a5}
    .footer{margin-top:30px; color:#667085; font-size:12px}
    .hr{height:1px; background:#1f2937; margin:12px 0}
    .hint{font-size:12px; color:#9ca3af}
    .danger-text{color:#f87171}
    .link{color:#93c5fd; cursor:pointer; text-decoration:underline}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0d1428; border:1px solid #1f2937}
    .empty{
      padding:28px; text-align:center; color:#94a3b8; border:1px dashed #1f2937; border-radius:12px;
      background:repeating-linear-gradient(45deg, #0c1426, #0c1426 10px, #0b1325 10px, #0b1325 20px);
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .small{font-size:12px}
    .sticky-actions{position:sticky; bottom:0; padding-top:10px; background:linear-gradient(180deg,transparent 0%, rgba(10,15,26,.9) 30%, rgba(10,15,26,1) 100%);}
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="flex">
      <div class="brand"><span class="dot"></span> Wildbestand – Kosten & Bestände</div>
      <div class="spacer"></div>
      <button class="btn ghost" id="backupBtn" title="Backup erstellen">Backup</button>
      <button class="btn ghost" id="restoreBtn" title="Backup einspielen">Wiederherstellen</button>
      <button class="btn ghost" id="csvBtn" title="CSV-Export">CSV</button>
      <button class="btn danger" id="resetBtn" title="Alles löschen">Zurücksetzen</button>
    </div>
    <nav id="tabs">
      <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn" data-tab="produkte">Produkte</button>
      <button class="tab-btn" data-tab="transaktionen">Transaktionen</button>
      <button class="tab-btn" data-tab="inventar">Inventar</button>
      <button class="tab-btn" data-tab="einstellungen">Einstellungen</button>
    </nav>
  </div>
</header>

<main class="container">
  <!-- DASHBOARD -->
  <section class="panel" data-panel="dashboard">
    <div class="flex" style="margin-bottom:10px">
      <h1>Übersicht</h1>
      <div class="spacer"></div>
      <div class="chips">
        <span class="tag"><span class="small muted">Kostenmethode</span> <strong id="costMethodLabel">Durchschnitt</strong></span>
        <span class="tag"><span class="small muted">Währung</span> <strong id="currencyLabel">€</strong></span>
      </div>
    </div>

    <div class="row grid-3">
      <div class="kpi">
        <small>Lagerwert (zu Durchschnittskosten)</small>
        <div class="value" id="kpiLagerwert">€ 0,00</div>
      </div>
      <div class="kpi">
        <small>Umsatz (Zeitraum)</small>
        <div class="value" id="kpiUmsatz">€ 0,00</div>
      </div>
      <div class="kpi">
        <small>COGS (Wareneinsatz, Zeitraum)</small>
        <div class="value" id="kpiCogs">€ 0,00</div>
      </div>
    </div>
    <div class="kpi" style="margin-top:16px">
      <small>Bruttomarge (Umsatz − COGS)</small>
      <div class="value" id="kpiMarge">€ 0,00</div>
    </div>

    <div class="hr"></div>
    <h2>Bestandswarnungen</h2>
    <div id="warnungen" class="empty">Keine Warnungen.</div>
  </section>

  <!-- PRODUKTE -->
  <section class="panel" data-panel="produkte" hidden>
    <div class="flex">
      <h1>Produkte</h1><div class="spacer"></div>
      <button class="btn brand" id="addProduktBtn">Neues Produkt</button>
    </div>
    <p class="hint">Produkte definieren die Einheiten, Kategorien und optional Zielverkaufspreise. Bestand und Durchschnittskosten ergeben sich aus den Transaktionen.</p>
    <div class="table-wrap" style="margin-top:12px">
      <table id="produkteTable">
        <thead>
          <tr>
            <th>Produkt</th>
            <th>Kategorie</th>
            <th>Teil (Cut)</th>
            <th>Einheit</th>
            <th class="right">Ziel VK/Einheit</th>
            <th class="right">Bestand</th>
            <th class="right">Ø-Kosten/Einheit</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="produkteBody"></tbody>
      </table>
    </div>

    <div class="hr"></div>
    <h2>Neues/ändern</h2>
    <div class="row" style="grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr">
      <div class="field"><label>Produktname</label><input id="pName" placeholder="z. B. Schwarzwild Keule"/></div>
      <div class="field"><label>Kategorie</label>
        <select id="pKat">
          <option>Schwarzwild</option>
          <option>Rehwild</option>
          <option>Damwild</option>
          <option>Sonstiges</option>
        </select>
      </div>
      <div class="field"><label>Teil / Schnitt</label>
        <select id="pTeil">
          <option>Nacken</option><option>Hackfleisch</option><option>Gulasch</option>
          <option>Keule</option><option>Blatt</option><option>Rücken</option><option>Sonstiges</option>
        </select>
      </div>
      <div class="field"><label>Einheit</label>
        <select id="pEinheit"><option>kg</option><option>Stück</option></select>
      </div>
      <div class="field"><label>Ziel VK/Einheit (€)</label><input type="number" step="0.01" id="pVk"/></div>
      <div class="field"><label>&nbsp;</label>
        <div class="flex">
          <button class="btn brand" id="saveProduktBtn">Speichern</button>
          <button class="btn" id="cancelProduktBtn">Abbrechen</button>
        </div>
      </div>
    </div>
    <div class="hint" style="margin-top:8px">Hinweis: Bestände und Kosten werden durch Transaktionen berechnet. Zum Start kannst du per <b>Korrektur</b> einen Anfangsbestand eintragen.</div>
  </section>

  <!-- TRANSAKTIONEN -->
  <section class="panel" data-panel="transaktionen" hidden>
    <div class="flex">
      <h1>Transaktionen</h1><div class="spacer"></div>
      <button class="btn brand" id="addTxnBtn">Neue Buchung</button>
    </div>
    <div class="chips" style="margin:8px 0 12px">
      <span class="tag"><span class="small muted">Zeitraum</span>
        <select id="rangeSelect" style="background:transparent; border:none; color:var(--text)">
          <option value="30">Letzte 30 Tage</option>
          <option value="90">Letzte 90 Tage</option>
          <option value="365">Letzte 12 Monate</option>
          <option value="all">Alle</option>
        </select></span>
      <span class="tag"><span class="small muted">Typ</span>
        <select id="typeFilter" style="background:transparent; border:none; color:var(--text)">
          <option value="all">Alle</option>
          <option>Einkauf</option><option>Produktion</option><option>Verkauf</option><option>Entnahme</option><option>Korrektur</option>
        </select></span>
    </div>
    <div class="table-wrap">
      <table id="txnTable">
        <thead>
          <tr>
            <th>Datum</th><th>Typ</th><th>Produkt</th><th class="right">Menge</th>
            <th class="right">Einzelpreis (€)</th><th class="right">Betrag (€)</th><th>Partner</th><th>Notiz</th><th></th>
          </tr>
        </thead>
        <tbody id="txnBody"></tbody>
      </table>
    </div>
    <div class="sticky-actions">
      <div class="flex">
        <div class="spacer"></div>
        <button class="btn" id="bulkDeleteBtn">Ausgewählte löschen</button>
      </div>
    </div>

    <div class="hr"></div>
    <h2>Neue Buchung</h2>
    <div class="row" style="grid-template-columns:repeat(8,1fr)">
      <div class="field"><label>Datum</label><input type="date" id="tDatum"/></div>
      <div class="field"><label>Typ</label>
        <select id="tTyp">
          <option>Einkauf</option><option>Produktion</option><option>Verkauf</option><option>Entnahme</option><option>Korrektur</option>
        </select>
      </div>
      <div class="field" style="grid-column: span 2;"><label>Produkt</label><select id="tProdukt"></select></div>
      <div class="field"><label>Menge</label><input type="number" step="0.001" id="tMenge" placeholder="z. B. 12.5"/></div>
      <div class="field"><label>Einzelpreis (€)</label><input type="number" step="0.01" id="tPreis" placeholder="bei Verkauf = VK/Einheit"/></div>
      <div class="field"><label>Partner</label><input id="tPartner" placeholder="Lieferant/Kunde"/></div>
      <div class="field"><label>Notiz</label><input id="tNotiz" placeholder="optional"/></div>
      <div class="field"><label>&nbsp;</label><button class="btn brand" id="tSpeichern">Buchen</button></div>
    </div>
    <div class="hint" style="margin-top:8px">
      <b>Kostenlogik:</b> Durchschnittskosten (Moving Average). <b>Einkauf/Produktion</b> erhöhen Bestand und passen den Ø-Preis an.
      <b>Verkauf/Entnahme</b> reduzieren Bestand und erzeugen COGS = Menge × Ø-Preis zum Buchungszeitpunkt.
      <b>Korrektur</b> setzt Bestand auf einen Zielwert (positiv/negativ), optional mit Wertansatz.
    </div>
  </section>

  <!-- INVENTAR -->
  <section class="panel" data-panel="inventar" hidden>
    <div class="flex">
      <h1>Inventar</h1><div class="spacer"></div>
      <div class="chips">
        <span class="tag"><span class="small muted">Warnschwelle</span>
          <input type="number" id="warnSchwelle" value="1" style="width:90px; background:transparent; border:none; color:var(--text)"/> </span>
      </div>
    </div>
    <div class="table-wrap" style="margin-top:12px">
      <table>
        <thead><tr>
          <th>Produkt</th><th>Kategorie</th><th>Einheit</th>
          <th class="right">Bestand</th><th class="right">Ø-Kosten/Einh.</th><th class="right">Lagerwert</th>
        </tr></thead>
        <tbody id="invBody"></tbody>
      </table>
    </div>
  </section>

  <!-- EINSTELLUNGEN -->
  <section class="panel" data-panel="einstellungen" hidden>
    <h1>Einstellungen</h1>
    <div class="row" style="grid-template-columns:repeat(3,1fr)">
      <div class="field"><label>Währungssymbol</label><input id="currency" value="€"/></div>
      <div class="field"><label>Kostenmethode</label>
        <select id="costMethod" disabled>
          <option value="avg" selected>Durchschnitt (Moving Average)</option>
        </select>
      </div>
      <div class="field"><label>Zeitzone</label><input value="Europe/Berlin" disabled/></div>
    </div>
    <p class="hint">Weitere Methoden (FIFO/LIFO) können später ergänzt werden – diese Version nutzt den laufenden Durchschnitt für robuste, einfache Kostenrechnung.</p>
  </section>

  <div class="footer">© <span id="yr"></span> – Lokale Datenablage (Browser). Keine Serververbindung.</div>
</main>

<input type="file" id="hiddenFile" accept=".json" style="display:none"/>

<script>
/* ==========================
   Datenmodell & Storage
   ========================== */
const LS_KEY = 'wb_v1';
const state = {
  settings:{ currency:'€', costMethod:'avg', lowStock:1 },
  products:[],        // {id, name, kat, teil, einheit, vkTarget}
  txns:[],            // {id, date, type, productId, qty, price, partner, note, cogsAtPost?, avgAtPost?}
  // abgeleitete Bestände werden on-the-fly berechnet
};

function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){
    try{ Object.assign(state, JSON.parse(raw)); }
    catch(e){ console.error(e) }
  }else{
    // Start mit ein paar Beispielprodukten (optional)
    state.products = [
      mkId({name:'Schwarzwild Keule', kat:'Schwarzwild', teil:'Keule', einheit:'kg', vkTarget:18}),
      mkId({name:'Rehwild Gulasch', kat:'Rehwild', teil:'Gulasch', einheit:'kg', vkTarget:24}),
    ];
  }
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function mkId(obj){ return Object.assign({id: crypto.randomUUID()}, obj); }

/* ==========================
   Hilfsfunktionen
   ========================== */
const fmtMoney = (n)=> (state.settings.currency||'€')+' '+(Number(n||0)).toLocaleString('de-DE',{minimumFractionDigits:2, maximumFractionDigits:2});
const fmtNum   = (n)=> (Number(n||0)).toLocaleString('de-DE',{maximumFractionDigits:3});
const byId = (id)=> document.getElementById(id);
const el = (tag, attrs={}, children=[])=>{
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') e.className=v;
    else if(k==='html') e.innerHTML=v;
    else e.setAttribute(k,v);
  });
  children.forEach(c=> e.append(c));
  return e;
};

/* ==========================
   Kostenrechnung (Moving Average)
   ========================== */
function recomputeInventory(){
  // Für jedes Produkt Bestände & Ø-Kosten aus allen Transaktionen chronologisch.
  const map = {}; // productId -> {qty, avg, lastAvg}
  const sorted = [...state.txns].sort((a,b)=> a.date.localeCompare(b.date) || a.id.localeCompare(b.id));
  sorted.forEach(tx=>{
    if(!map[tx.productId]) map[tx.productId] = {qty:0, avg:0};
    const p = map[tx.productId];
    const qty = Number(tx.qty||0);
    const price = Number(tx.price||0);

    if(tx.type==='Einkauf' || tx.type==='Produktion'){
      // Neuer Durchschnitt: (altWert + neuWert) / neue Gesamtmenge
      const altWert = p.qty * p.avg;
      const neuWert = qty * price;
      const neuQty  = p.qty + qty;
      p.avg = neuQty>0 ? (altWert + neuWert)/neuQty : 0;
      p.qty = neuQty;
      tx.avgAtPost = p.avg;
      tx.cogsAtPost = 0;
    }else if(tx.type==='Verkauf' || tx.type==='Entnahme'){
      const cogs = qty * p.avg;
      p.qty = (p.qty - qty);
      if(p.qty < -1e-9) p.qty = p.qty; // negatives zulassen (Warnung)
      // Durchschnitt bleibt gleich
      tx.avgAtPost = p.avg;
      tx.cogsAtPost = cogs;
    }else if(tx.type==='Korrektur'){
      // Korrektur setzt auf Zielbestand. Optionaler Preis wirkt nur bei positiver Erhöhung.
      const delta = qty - p.qty; // qty = Ziel
      if(delta>0 && price>0){
        const altWert = p.qty * p.avg;
        const neuWert = delta * price;
        const neuQty  = qty;
        p.avg = neuQty>0 ? (altWert + neuWert)/neuQty : 0;
      }
      p.qty = qty;
      tx.avgAtPost = p.avg;
      tx.cogsAtPost = 0;
    }
  });
  return map;
}

function inventorySummary(){
  const inv = recomputeInventory();
  let lagerwert = 0;
  state.products.forEach(pr=>{
    const p = inv[pr.id] || {qty:0, avg:0};
    lagerwert += p.qty * p.avg;
  });
  return { inv, lagerwert };
}

function rangeFilterDays(txns, days){
  if(days==='all') return txns;
  const ms = Number(days)*24*3600*1000;
  const cutoff = Date.now() - ms;
  return txns.filter(t => new Date(t.date).getTime() >= cutoff);
}

/* ==========================
   UI Binding
   ========================== */
function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab===name);
  });
  document.querySelectorAll('[data-panel]').forEach(p=>{
    p.hidden = p.dataset.panel !== name;
  });
}

function initTabs(){
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.addEventListener('click',()=> switchTab(b.dataset.tab));
  });
}

function refreshDashboard(){
  const rangeVal = byId('rangeSelect')?.value || '30';
  const txRange = rangeFilterDays(state.txns, rangeVal);
  const {inv, lagerwert} = inventorySummary();

  // KPI Umsatz/COGS/Marge (Zeitraum)
  const umsatz = txRange.filter(t=>t.type==='Verkauf').reduce((s,t)=> s + Number(t.qty)*Number(t.price), 0);
  const cogs   = txRange.filter(t=>t.type==='Verkauf' || t.type==='Entnahme').reduce((s,t)=> s + Number(t.cogsAtPost||0), 0);
  const marge  = umsatz - cogs;

  byId('kpiLagerwert').textContent = fmtMoney(lagerwert);
  byId('kpiUmsatz').textContent = fmtMoney(umsatz);
  byId('kpiCogs').textContent = fmtMoney(cogs);
  byId('kpiMarge').textContent = fmtMoney(marge);

  // Warnungen
  const low = state.settings.lowStock || 1;
  const rows = state.products.map(pr=>{
    const p = inv[pr.id] || {qty:0, avg:0};
    return {name: pr.name, qty: p.qty, einheit: pr.einheit};
  }).filter(x=> x.qty <= low);

  const wrap = byId('warnungen');
  wrap.innerHTML = '';
  if(rows.length===0){
    wrap.className='empty';
    wrap.textContent='Keine Warnungen.';
  }else{
    wrap.className='';
    const list = el('div', {class:'chips'});
    rows.forEach(r=>{
      list.append(el('span', {class:'tag'}, [
        el('span', {class:'small muted', html:'Niedrig'}),
        el('strong', {html:`${r.name}: ${fmtNum(r.qty)} ${r.einheit}`})
      ]));
    });
    wrap.append(list);
  }

  // Labels
  byId('currencyLabel').textContent = state.settings.currency || '€';
  byId('costMethodLabel').textContent = 'Durchschnitt';
}

function refreshProdukte(){
  const body = byId('produkteBody');
  body.innerHTML='';
  const {inv} = inventorySummary();

  if(state.products.length===0){
    body.append(el('tr',{},[
      el('td',{colspan:8},[ el('div',{class:'empty',html:'Noch keine Produkte. Lege oben ein neues an.'}) ])
    ]));
    return;
  }

  state.products.forEach(pr=>{
    const p = inv[pr.id] || {qty:0, avg:0};
    const tr = el('tr',{},[
      el('td', {html:pr.name}),
      el('td', {html:pr.kat}),
      el('td', {html:pr.teil}),
      el('td', {html:pr.einheit}),
      el('td', {class:'right', html: pr.vkTarget? fmtMoney(pr.vkTarget): '—'}),
      el('td', {class:'right', html: fmtNum(p.qty)}),
      el('td', {class:'right', html: fmtMoney(p.avg)}),
      el('td', {}, [
        btn('Bearbeiten', ()=> loadProduktToForm(pr.id)),
        spacer(),
        btn('Löschen', ()=> deleteProdukt(pr.id), 'danger')
      ])
    ]);
    body.append(tr);
  });

  // Produkt-Dropdown für Transaktionen
  const sel = byId('tProdukt'); sel.innerHTML='';
  state.products.forEach(pr=>{
    const op = el('option', {value:pr.id, html: pr.name});
    sel.append(op);
  });
}
function spacer(){ return el('span',{style:'margin:0 4px'}) }
function btn(label, fn, variant=''){ const b=el('button',{class:`btn ${variant}`,html:label}); b.addEventListener('click',fn); return b; }

let editProduktId = null;
function loadProduktToForm(id){
  const pr = state.products.find(p=>p.id===id);
  if(!pr) return;
  editProduktId = id;
  byId('pName').value = pr.name;
  byId('pKat').value = pr.kat;
  byId('pTeil').value = pr.teil;
  byId('pEinheit').value = pr.einheit;
  byId('pVk').value = pr.vkTarget ?? '';
  window.scrollTo({top:0, behavior:'smooth'});
}
function clearProduktForm(){
  editProduktId=null;
  byId('pName').value=''; byId('pKat').value='Schwarzwild'; byId('pTeil').value='Nacken';
  byId('pEinheit').value='kg'; byId('pVk').value='';
}
function saveProdukt(){
  const pr = {
    name: byId('pName').value.trim(),
    kat: byId('pKat').value,
    teil: byId('pTeil').value,
    einheit: byId('pEinheit').value,
    vkTarget: byId('pVk').value ? Number(byId('pVk').value) : null
  };
  if(!pr.name){ alert('Produktname fehlt'); return; }
  if(editProduktId){
    const i = state.products.findIndex(p=>p.id===editProduktId);
    if(i>=0) state.products[i] = Object.assign({}, state.products[i], pr);
  }else{
    state.products.push(mkId(pr));
  }
  save(); refreshProdukte(); refreshDashboard(); clearProduktForm();
}
function deleteProdukt(id){
  if(state.txns.some(t=>t.productId===id)){
    if(!confirm('Für dieses Produkt existieren Transaktionen. Produkt trotzdem löschen? (Transaktionen bleiben erhalten)')) return;
  }
  state.products = state.products.filter(p=>p.id!==id);
  save(); refreshProdukte(); refreshDashboard();
}

function refreshTxns(){
  const tbody = byId('txnBody'); tbody.innerHTML='';
  const tf = byId('typeFilter').value;
  const rangeVal = byId('rangeSelect').value;
  const txns = rangeFilterDays(state.txns, rangeVal)
    .filter(t=> tf==='all' ? true : t.type===tf)
    .sort((a,b)=> b.date.localeCompare(a.date) || b.id.localeCompare(a.id));

  if(txns.length===0){
    tbody.append(el('tr',{},[
      el('td',{colspan:9},[ el('div',{class:'empty',html:'Noch keine Transaktionen im gewählten Filter.'}) ])
    ]));
    return;
  }

  const prodName = id => state.products.find(p=>p.id===id)?.name || '—';
  txns.forEach(t=>{
    const amount = Number(t.qty)*Number(t.price||0);
    const tr = el('tr',{},[
      el('td',{html:new Date(t.date).toLocaleDateString('de-DE')}),
      el('td',{html:t.type}),
      el('td',{html:prodName(t.productId)}),
      el('td',{class:'right', html: fmtNum(t.qty)}),
      el('td',{class:'right', html: t.price? fmtMoney(t.price): '—'}),
      el('td',{class:'right', html: t.price? fmtMoney(amount): '—'}),
      el('td',{html:t.partner||'—'}),
      el('td',{html:t.note||'—'}),
      el('td',{},[
        el('input',{type:'checkbox','data-id':t.id, title:'Markieren'})
      ]),
    ]);
    tbody.append(tr);
  });

  refreshDashboard(); // KPIs mit aktuellem Range
}

function postTxn(){
  const date = byId('tDatum').value || new Date().toISOString().slice(0,10);
  const type = byId('tTyp').value;
  const productId = byId('tProdukt').value;
  const qty = Number(byId('tMenge').value);
  const price = byId('tPreis').value ? Number(byId('tPreis').value) : 0;
  const partner = byId('tPartner').value.trim();
  const note = byId('tNotiz').value.trim();

  if(!productId){ alert('Bitte ein Produkt wählen.'); return; }
  if(!(qty>0) && type!=='Korrektur'){ alert('Menge > 0 erforderlich.'); return; }
  if(type==='Verkauf' && !(price>0)){ alert('Verkaufspreis pro Einheit erforderlich.'); return; }
  if((type==='Einkauf' || type==='Produktion') && !(price>0)){ alert('Einstandspreis/Herstellkosten pro Einheit erforderlich.'); return; }
  // Für Korrektur ist qty der Zielbestand (>=0 erlaubt)
  if(type==='Korrektur' && !(qty>=0)){ alert('Zielbestand (>=0) angeben.'); return; }

  const txn = mkId({date, type, productId, qty, price, partner, note});
  state.txns.push(txn);
  // Nach jeder Buchung sofort neu berechnen, damit cogsAtPost/avgAtPost gefüllt sind
  recomputeInventory();
  save();
  refreshTxns(); refreshProdukte(); refreshDashboard();
  // Formular teils leeren
  byId('tMenge').value=''; byId('tPreis').value=''; byId('tPartner').value=''; byId('tNotiz').value='';
}

function bulkDelete(){
  const ids = [...document.querySelectorAll('#txnBody input[type=checkbox]:checked')].map(x=>x.dataset.id);
  if(ids.length===0){ alert('Nichts ausgewählt.'); return; }
  if(!confirm(`Wirklich ${ids.length} Buchung(en) löschen?`)) return;
  state.txns = state.txns.filter(t=> !ids.includes(t.id));
  recomputeInventory(); save(); refreshTxns(); refreshProdukte(); refreshDashboard();
}

function refreshInventar(){
  const {inv} = inventorySummary();
  const tbody = byId('invBody'); tbody.innerHTML='';
  if(state.products.length===0){
    tbody.append(el('tr',{},[
      el('td',{colspan:6},[ el('div',{class:'empty',html:'Keine Produkte vorhanden.'}) ])
    ]));
    return;
  }
  state.products.forEach(pr=>{
    const p = inv[pr.id] || {qty:0, avg:0};
    const tr = el('tr',{},[
      el('td',{html:pr.name}),
      el('td',{html:pr.kat}),
      el('td',{html:pr.einheit}),
      el('td',{class:'right', html:fmtNum(p.qty)}),
      el('td',{class:'right', html:fmtMoney(p.avg)}),
      el('td',{class:'right', html:fmtMoney(p.qty*p.avg)}),
    ]);
    tbody.append(tr);
  });
}

/* ==========================
   Export/Import/Reset
   ========================== */
function backup(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `wildbestand_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(a.href);
}
function restore(file){
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const data = JSON.parse(e.target.result);
      // einfache Validierung
      if(!data || !Array.isArray(data.products) || !Array.isArray(data.txns)) throw new Error('Ungültige Datei');
      state.settings = Object.assign({currency:'€',costMethod:'avg',lowStock:1}, data.settings||{});
      state.products = data.products||[];
      state.txns = data.txns||[];
      save(); recomputeInventory();
      refreshProdukte(); refreshTxns(); refreshInventar(); refreshDashboard();
      alert('Backup erfolgreich eingespielt.');
    }catch(err){
      alert('Fehler beim Einspielen: '+err.message);
    }
  };
  reader.readAsText(file);
}
function exportCSV(){
  // CSV der Transaktionen
  const header = ['Datum','Typ','Produkt','Menge','Preis/Einheit','Betrag','COGS bei Buchung','Partner','Notiz'];
  const prodName = id => state.products.find(p=>p.id===id)?.name || '';
  const rows = state.txns.map(t=>[
    t.date, t.type, prodName(t.productId), t.qty, t.price, (t.qty*(t.price||0)).toFixed(2),
    (t.cogsAtPost||0).toFixed(2), (t.partner||''), (t.note||'')
  ]);
  const csv = [header, ...rows].map(r=> r.map(v=>{
    const s = String(v??'');
    return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(';')).join('\n');

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `transaktionen_${new Date().toISOString().slice(0,10)}.csv`;
  a.click(); URL.revokeObjectURL(a.href);
}
function resetAll(){
  if(!confirm('Alle Daten wirklich löschen?')) return;
  localStorage.removeItem(LS_KEY);
  state.settings={ currency:'€', costMethod:'avg', lowStock:1 };
  state.products=[]; state.txns=[];
  save(); refreshProdukte(); refreshTxns(); refreshInventar(); refreshDashboard();
}

/* ==========================
   Event Listeners
   ========================== */
function initEvents(){
  byId('yr').textContent = new Date().getFullYear();

  // Tabs
  initTabs();

  // Produkte
  byId('addProduktBtn').addEventListener('click', ()=> { switchTab('produkte'); clearProduktForm(); byId('pName').focus(); });
  byId('saveProduktBtn').addEventListener('click', saveProdukt);
  byId('cancelProduktBtn').addEventListener('click', clearProduktForm);

  // Transaktionen
  byId('addTxnBtn').addEventListener('click', ()=> switchTab('transaktionen'));
  byId('tSpeichern').addEventListener('click', postTxn);
  byId('typeFilter').addEventListener('change', refreshTxns);
  byId('rangeSelect').addEventListener('change', ()=>{ refreshTxns(); refreshDashboard(); });
  byId('bulkDeleteBtn').addEventListener('click', bulkDelete);

  // Inventar
  byId('warnSchwelle').addEventListener('change', (e)=>{ state.settings.lowStock = Number(e.target.value)||1; save(); refreshDashboard(); });

  // Einstellungen
  byId('currency').addEventListener('input', (e)=>{ state.settings.currency = e.target.value||'€'; save(); refreshDashboard(); });
  byId('costMethod').addEventListener('change', ()=>{}); // nur Anzeige

  // Export/Import/Reset
  byId('backupBtn').addEventListener('click', backup);
  byId('restoreBtn').addEventListener('click', ()=> byId('hiddenFile').click());
  byId('csvBtn').addEventListener('click', exportCSV);
  byId('resetBtn').addEventListener('click', resetAll);
  byId('hiddenFile').addEventListener('change', (e)=> e.target.files[0] && restore(e.target.files[0]));
}

/* ==========================
   Boot
   ========================== */
load(); // aus LS
document.addEventListener('DOMContentLoaded', ()=>{
  refreshProdukte(); refreshTxns(); refreshInventar(); refreshDashboard();
  byId('currency').value = state.settings.currency||'€';
  byId('warnSchwelle').value = state.settings.lowStock||1;
  byId('yr').textContent = new Date().getFullYear();
  initEvents();
});
</script>
</body>
</html>
